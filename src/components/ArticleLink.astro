---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { routes } from "src/routing";
import { formatDistance } from "date-fns";
import getReadingTime from "reading-time";

export type Props = CollectionEntry<"blog"> & {
  isNew: boolean;
};
const { data, slug, isNew, body } = Astro.props;
const { banner } = data;
const readingTime = getReadingTime(body);
---

<a
  data-article-id={slug}
  data-is-new={isNew ? "true" : "false"}
  href={routes.article(slug)}
  rel="prefetch"
  class="article-entry flex group @container h-full transition-transform duration-300 transform-gpu rounded outline outline-1 outline-body-700 bg-body-900"
>
  <div class="flex flex-row flex-1 relative h-full">
    <div class="z-1 flex-1">
      <div class="flex flex-col gap-2 px-4 py-4">
        <h2
          class="article-title text-lg font-medium leading-5 w-fit"
          transition:name={`title-${slug}`}
        >
          {data.title}
        </h2>
        <p
          class="color-text-100 text-wrap-balance leading-6"
          transition:name={`subtitle-${slug}`}
        >
          {data.description}
        </p>
        <time
          class="text-xs color-text-300 leading-3"
          datetime={data.date.toString()}
          transition:name={`date-${slug}`}
          >Posted {
            formatDistance(data.date, new Date(), { addSuffix: true })
          }</time
        >
      </div>
      <hr class="w-full article-bottom-border h-[1px]" />
      <ul class="flex px-4 py-2 gap-2 flex-wrap text-xs color-text-100">
        <div class="color-text-300" transition:name={`reading-time-${slug}`}>
          {readingTime.text}
        </div>
        <div class="h-full w-[1px] bg-body-700 mr-2"></div>
        {data.tags.map((tag) => <div class="pr-2">{tag}</div>)}
      </ul>
    </div>
    {
      banner && (
        <div
          style={{ aspectRatio: "16/9" }}
          class="hidden @xl:block ml-auto overflow-hidden rounded overflow-hidden z-2 max-w-[200px] w-full object-cover h-full ml-auto flex-shrink-0"
        >
          {isNew && (
            <div class="new-tag hidden z-2 tracking-wider font-bold text-xs absolute right-0 top-0 text-center rounded m-2 px-2 bg-brand-900 color-white">
              NEW
            </div>
          )}
          <Image
            width={500}
            alt="Banner for article generated by midjourney"
            loading="lazy"
            class="article-image object-cover absolute min-w-[200px] w-auto max-w-[200px] right-0 z-1 rounded-r image-overlay transition-all h-full"
            src={banner}
            transition:name={`splash-${slug}`}
          />
        </div>
      )
    }
  </div>
</a>

<script>
  import { annotate } from "rough-notation";

  type Annotation = ReturnType<typeof annotate>;
  const highlightColor = getComputedStyle(
    document.documentElement,
  ).getPropertyValue("--text-100");

  document.querySelectorAll(".article-entry").forEach((article) => {
    if (article instanceof HTMLElement) {
      let annotation: Annotation | undefined;
      article.addEventListener("mouseenter", (event) => {
        if (event.target instanceof HTMLElement) {
          const title = event.target?.querySelector(".article-title");
          if (!title) return;

          annotation = annotate(title as HTMLElement, {
            type: "underline",
            color: highlightColor,
          });
          annotation.show();
        }
      });

      article.addEventListener("mouseleave", () => {
        if (annotation) {
          annotation.remove();
        }
      });

      if (article.dataset.isNew === "false") {
        return;
      }
      const id = article.dataset.articleId;
      if (localStorage.getItem(`article-${id}`)) {
        return;
      }
      article.classList.add("unread");
    }
  });
</script>

<style>
  .article-bottom-border {
    border: none;
    background: linear-gradient(to right, var(--body-700), transparent);
  }
  .article-image {
    clip-path: polygon(0 0, 100% 0, 100% 100%, 20% 100%);
    /* -webkit-mask-image: linear-gradient(to left, black, transparent),
      radial-gradient(at 0 0, black, transparent); */
  }

  .unread .new-tag {
    display: block;
  }
</style>
